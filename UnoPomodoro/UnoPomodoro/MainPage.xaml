<Page x:Class="UnoPomodoro.MainPage"
     xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
     xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
     xmlns:local="using:UnoPomodoro.ViewModels"
     xmlns:converters="using:UnoPomodoro.Converters"
     xmlns:controls="using:Microsoft.UI.Xaml.Controls"
     xmlns:customControls="using:UnoPomodoro.Controls"
     Background="{StaticResource BackgroundColor}">
  <Page.Resources>
    <converters:ModeToColorConverter x:Key="ModeToColorConverter" />
    <converters:TimeToStringConverter x:Key="TimeToStringConverter" />
    <converters:BoolToStringConverter x:Key="BoolToStringConverter" />
    <converters:BoolToColorConverter x:Key="BoolToColorConverter" />
    <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
    <converters:SessionIdToTextConverter x:Key="SessionIdToTextConverter" />
    <converters:ProgressToColorConverter x:Key="ProgressToColorConverter" />
    <converters:ModeToTextConverter x:Key="ModeToTextConverter" />
    <converters:BoolToOpacityConverter x:Key="BoolToOpacityConverter" />

    <!-- Animation Storyboard -->
    <Storyboard x:Key="TimerPulseAnimation">
      <DoubleAnimation Storyboard.TargetName="TimerDisplay"
                       Storyboard.TargetProperty="Opacity"
                       From="0.6" To="1.0" Duration="0:0:1"
                       AutoReverse="True" RepeatBehavior="Forever" />
    </Storyboard>
  </Page.Resources>

  <Page.DataContext>
    <!-- ViewModel will be set programmatically in code-behind -->
  </Page.DataContext>

  <Grid>
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto" />
      <RowDefinition Height="*" />
    </Grid.RowDefinitions>

    <!-- Navigation Bar -->
    <Grid Grid.Row="0"
          x:Name="TopNavGrid"
          Background="{StaticResource SurfaceColor}"
          Padding="16,8">
      <Grid.RowDefinitions>
        <RowDefinition Height="Auto" />
        <RowDefinition Height="Auto" />
      </Grid.RowDefinitions>
      <Grid.ColumnDefinitions>
        <ColumnDefinition Width="*" />
        <ColumnDefinition Width="Auto" />
      </Grid.ColumnDefinitions>

      <VisualStateManager.VisualStateGroups>
        <VisualStateGroup x:Name="TopNavStates">
          <VisualState x:Name="TopNavCompact">
            <VisualState.StateTriggers>
              <AdaptiveTrigger MinWindowWidth="0" />
            </VisualState.StateTriggers>
            <VisualState.Setters>
              <Setter Target="NavButtonPanel.Orientation" Value="Vertical" />
              <Setter Target="NavButtonPanel.HorizontalAlignment" Value="Stretch" />
              <Setter Target="UtilityButtonPanel.(Grid.Row)" Value="1" />
              <Setter Target="UtilityButtonPanel.(Grid.Column)" Value="0" />
              <Setter Target="UtilityButtonPanel.(Grid.ColumnSpan)" Value="2" />
              <Setter Target="UtilityButtonPanel.HorizontalAlignment" Value="Left" />
            </VisualState.Setters>
          </VisualState>

          <VisualState x:Name="TopNavWide">
            <VisualState.StateTriggers>
              <AdaptiveTrigger MinWindowWidth="600" />
            </VisualState.StateTriggers>
            <VisualState.Setters>
              <Setter Target="NavButtonPanel.Orientation" Value="Horizontal" />
              <Setter Target="NavButtonPanel.HorizontalAlignment" Value="Left" />
              <Setter Target="UtilityButtonPanel.(Grid.Row)" Value="0" />
              <Setter Target="UtilityButtonPanel.(Grid.Column)" Value="1" />
              <Setter Target="UtilityButtonPanel.(Grid.ColumnSpan)" Value="1" />
              <Setter Target="UtilityButtonPanel.HorizontalAlignment" Value="Right" />
            </VisualState.Setters>
          </VisualState>
        </VisualStateGroup>
      </VisualStateManager.VisualStateGroups>

      <StackPanel x:Name="NavButtonPanel"
                  Grid.Row="0"
                  Grid.Column="0"
                  Orientation="Horizontal"
                  Spacing="12"
                  VerticalAlignment="Center">
        <Button Content="Timer"
                Click="OnTimerClick"
                Style="{StaticResource SecondaryButtonStyle}"
                Padding="12,8"
                MinWidth="70" />
        <Button Content="Dashboard"
                Click="OnDashboardClick"
                Style="{StaticResource SecondaryButtonStyle}"
                Padding="12,8"
                MinWidth="90" />
        <Button Content="History"
                Click="OnHistoryClick"
                Style="{StaticResource SecondaryButtonStyle}"
                Padding="12,8"
                MinWidth="70" />
        <Button Content="Settings"
                Click="OnSettingsClick"
                Style="{StaticResource SecondaryButtonStyle}"
                Padding="12,8"
                MinWidth="70" />
      </StackPanel>

            <StackPanel x:Name="UtilityButtonPanel"
            Grid.Row="0"
            Grid.Column="1"
            Orientation="Horizontal"
            Spacing="8"
            VerticalAlignment="Center">
        <Button Content="ðŸ”Š"
                Command="{Binding ToggleSoundCommand}"
                Style="{StaticResource SecondaryButtonStyle}"
                Padding="8"
                Width="40"
                Height="40" />
        <Button Content="âš™ï¸"
                Click="OnSettingsClick"
                Style="{StaticResource SecondaryButtonStyle}"
                Padding="8"
                Width="40"
                Height="40" />
      </StackPanel>
    </Grid>

    <!-- Main Content -->
    <ScrollViewer Grid.Row="1" Padding="16" HorizontalScrollBarVisibility="Disabled">
      <Grid RowSpacing="24" MaxWidth="720" HorizontalAlignment="Center">
        <Grid.RowDefinitions>
          <RowDefinition Height="Auto" />
          <RowDefinition Height="Auto" />
          <RowDefinition Height="Auto" />
          <RowDefinition Height="Auto" />
          <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Mode Selection -->
        <Grid Grid.Row="0" ColumnSpacing="8">
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="*" />
          </Grid.ColumnDefinitions>

          <!-- Pomodoro Mode -->
          <Border Grid.Column="0"
                  Style="{StaticResource CardStyle}"
                  Background="{Binding Mode, Converter={StaticResource ModeToColorConverter}, ConverterParameter=pomodoro}"
                  Padding="8">
            <Button Command="{Binding ChangeModeCommand}"
                    CommandParameter="pomodoro"
                    Style="{StaticResource PrimaryButtonStyle}"
                    Content="Pomodoro"
                    HorizontalAlignment="Stretch"
                    Margin="0"
                    Padding="8,12" />
          </Border>

          <!-- Short Break Mode -->
          <Border Grid.Column="1"
                  Style="{StaticResource CardStyle}"
                  Background="{Binding Mode, Converter={StaticResource ModeToColorConverter}, ConverterParameter=shortBreak}"
                  Padding="8">
            <Button Command="{Binding ChangeModeCommand}"
                    CommandParameter="shortBreak"
                    Style="{StaticResource PrimaryButtonStyle}"
                    HorizontalAlignment="Stretch"
                    Margin="0"
                    Padding="8,12">
              <TextBlock Text="Short Break Mode"
                 TextAlignment="Center"
                 TextWrapping="Wrap" />
            </Button>
          </Border>

          <!-- Long Break Mode -->
          <Border Grid.Column="2"
                  Style="{StaticResource CardStyle}"
                  Background="{Binding Mode, Converter={StaticResource ModeToColorConverter}, ConverterParameter=longBreak}"
                  Padding="8">
            <Button Command="{Binding ChangeModeCommand}"
                    CommandParameter="longBreak"
                    Style="{StaticResource PrimaryButtonStyle}"
                    HorizontalAlignment="Stretch"
                    Margin="0"
                    Padding="8,12">
              <TextBlock Text="Long Break Mode"
                 TextAlignment="Center"
                 TextWrapping="Wrap" />
            </Button>
          </Border>
        </Grid>

        <!-- Timer Display -->
        <Border Grid.Row="1" Style="{StaticResource CardStyle}">
          <StackPanel Spacing="24" HorizontalAlignment="Center">
            <!-- Digital Timer -->
            <TextBlock x:Name="TimerDisplay"
                       Text="{Binding TimeLeft, Converter={StaticResource TimeToStringConverter}}"
                       Style="{StaticResource TimerDisplayStyle}" />

            <!-- Analog Clock -->
            <customControls:AnalogClock
                TimeLeft="{Binding TimeLeft}"
                TotalTime="{Binding TotalDuration}"
              ProgressBrush="{Binding Mode, Converter={StaticResource ModeToColorConverter}}"
              ClockSize="240"
                HorizontalAlignment="Center" />

            <!-- Session Info -->
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Spacing="12">
              <TextBlock Text="{Binding Mode, Converter={StaticResource ModeToTextConverter}}"
                         FontSize="16"
                         Foreground="{StaticResource OnSurfaceVariantColor}" />
              <TextBlock Text="â€¢"
                         FontSize="16"
                         Foreground="{StaticResource OnSurfaceVariantColor}" />
              <TextBlock Text="{Binding SessionInfo}"
                         FontSize="16"
                         Foreground="{StaticResource OnSurfaceVariantColor}" />
            </StackPanel>
          </StackPanel>
        </Border>

        <!-- Timer Controls -->
        <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Center" Spacing="12">
          <Button Content="{Binding IsRunning, Converter={StaticResource BoolToStringConverter}, ConverterParameter=â¸ Pause/â–¶ Start}"
                  Command="{Binding ToggleTimerCommand}"
                  Style="{StaticResource PrimaryButtonStyle}"
                  MinWidth="110"
                  Height="48"
                  Padding="16,12" />
          <Button Content="â†º Reset"
                  Command="{Binding ResetTimerCommand}"
                  Style="{StaticResource SecondaryButtonStyle}"
                  MinWidth="100"
                  Height="48"
                  Padding="16,12" />
          <Button Content="â­ Skip"
                  Command="{Binding SkipSessionCommand}"
                  Style="{StaticResource SecondaryButtonStyle}"
                  MinWidth="90"
                  Height="48"
                  Padding="16,12" />
        </StackPanel>

        <!-- Quick Actions -->
        <Grid Grid.Row="3" ColumnSpacing="12">
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="*" />
          </Grid.ColumnDefinitions>

          <!-- Sound Control -->
          <Border Grid.Column="0" Style="{StaticResource CardStyle}">
            <StackPanel Spacing="8" HorizontalAlignment="Center">
              <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
                <Button Content="{Binding IsSoundEnabled, Converter={StaticResource BoolToStringConverter}, ConverterParameter=ðŸ”‡/ðŸ”Š}"
                        Command="{Binding ToggleSoundCommand}"
                        Style="{StaticResource SecondaryButtonStyle}"
                        Width="50"
                        Height="40"
                        Padding="8" />
                <Button Command="{Binding TestSoundCommand}"
                        Style="{StaticResource SecondaryButtonStyle}"
                        Height="40"
                        Padding="12,8">
                  <TextBlock Text="Test&#x0a;Sound" TextAlignment="Center" FontSize="11" />
                </Button>
              </StackPanel>
              <Button Content="Stop Alarm"
                      Command="{Binding StopAlarmCommand}"
                      Style="{StaticResource PrimaryButtonStyle}"
                      HorizontalAlignment="Stretch"
                      Visibility="{Binding IsRinging, Converter={StaticResource BoolToVisibilityConverter}}"
                      Padding="12,8" />
            </StackPanel>
          </Border>

          <!-- Session Control -->
          <Border Grid.Column="1" Style="{StaticResource CardStyle}">
            <StackPanel Spacing="8" HorizontalAlignment="Center">
              <Button Command="{Binding StartNewSessionCommand}"
                      Style="{StaticResource PrimaryButtonStyle}"
                      HorizontalAlignment="Stretch"
                      Padding="12,8">
                <TextBlock Text="New&#x0a;Session" TextAlignment="Center" />
              </Button>
              <Button Command="{Binding ToggleTasksCommand}"
                      Style="{StaticResource SecondaryButtonStyle}"
                      HorizontalAlignment="Stretch"
                      Padding="12,8">
                <TextBlock Text="View&#x0a;Tasks" TextAlignment="Center" />
              </Button>
            </StackPanel>
          </Border>
        </Grid>

        <!-- Current Tasks -->
        <Border Grid.Row="4" Style="{StaticResource CardStyle}" Visibility="{Binding ShowTasks, Converter={StaticResource BoolToVisibilityConverter}}">
          <StackPanel Spacing="15">
            <TextBlock Text="Current Session Tasks"
                       FontSize="20"
                       FontWeight="Medium"
                       Foreground="{StaticResource OnSurfaceColor}" />

            <!-- Add Task -->
            <Grid ColumnSpacing="10">
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
              </Grid.ColumnDefinitions>

              <TextBox Grid.Column="0"
                       Text="{Binding NewTask, Mode=TwoWay}"
                       PlaceholderText="Add a new task..."
                       Style="{StaticResource PrimaryButtonStyle}" />

              <Button Grid.Column="1"
                      Content="Add"
                      Command="{Binding AddTaskCommand}"
                      Style="{StaticResource PrimaryButtonStyle}"
                      MinWidth="60" />
            </Grid>

            <!-- Task List -->
            <ItemsControl x:Name="TaskList" ItemsSource="{Binding Tasks}">
              <ItemsControl.ItemTemplate>
                <DataTemplate>
                  <Border Margin="0,5,0,5"
                          Padding="10"
                          CornerRadius="8"
                          Background="{StaticResource SurfaceVariantColor}">
                    <Grid ColumnSpacing="10">
                      <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                      </Grid.ColumnDefinitions>

                      <CheckBox Grid.Column="0"
                                IsChecked="{Binding Completed, Mode=TwoWay}" />

                      <TextBlock Grid.Column="1"
                                 Text="{Binding Text}"
                                 VerticalAlignment="Center"
                                 TextWrapping="Wrap"
                                 Foreground="{Binding Completed, Converter={StaticResource BoolToColorConverter}}"
                                 Opacity="{Binding Completed, Converter={StaticResource BoolToOpacityConverter}}" />

                      <Button Grid.Column="2"
                              Content="Ã—"
                              Command="{Binding DataContext.DeleteTaskCommand, ElementName=TaskList}"
                              CommandParameter="{Binding Id}"
                              Style="{StaticResource SecondaryButtonStyle}"
                              Width="32"
                              Height="32"
                              Padding="0"
                              FontSize="20" />
                    </Grid>
                  </Border>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
            </ItemsControl>
          </StackPanel>
        </Border>
      </Grid>
    </ScrollViewer>
  </Grid>
</Page>
