<Page x:Class="UnoPomodoro.MainPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:local="using:UnoPomodoro.ViewModels"
      xmlns:converters="using:UnoPomodoro.Converters"
      xmlns:controls="using:Microsoft.UI.Xaml.Controls"
      Background="{StaticResource BackgroundColor}">
  <Page.Resources>
    <converters:ModeToColorConverter x:Key="ModeToColorConverter" />
    <converters:TimeToStringConverter x:Key="TimeToStringConverter" />
    <converters:BoolToStringConverter x:Key="BoolToStringConverter" />
    <converters:BoolToColorConverter x:Key="BoolToColorConverter" />
    <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
    <converters:SessionIdToTextConverter x:Key="SessionIdToTextConverter" />
    <converters:ProgressToColorConverter x:Key="ProgressToColorConverter" />
    <converters:ModeToTextConverter x:Key="ModeToTextConverter" />
    <converters:BoolToOpacityConverter x:Key="BoolToOpacityConverter" />

    <!-- Animation Storyboard -->
    <Storyboard x:Key="TimerPulseAnimation">
      <DoubleAnimation Storyboard.TargetName="TimerDisplay"
                       Storyboard.TargetProperty="Opacity"
                       From="0.6" To="1.0" Duration="0:0:1"
                       AutoReverse="True" RepeatBehavior="Forever" />
    </Storyboard>
  </Page.Resources>

  <Page.DataContext>
    <!-- ViewModel will be set programmatically in code-behind -->
  </Page.DataContext>

  <Grid>
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto" />
      <RowDefinition Height="*" />
    </Grid.RowDefinitions>

    <!-- Navigation Bar -->
    <Grid Grid.Row="0" Height="60" Background="{StaticResource SurfaceColor}" Padding="16,0">
      <Grid.ColumnDefinitions>
        <ColumnDefinition Width="*" />
        <ColumnDefinition Width="Auto" />
      </Grid.ColumnDefinitions>

      <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="20" VerticalAlignment="Center">
        <Button Content="Timer"
                Click="OnTimerClick"
                Style="{StaticResource SecondaryButtonStyle}"
                Padding="16,8" />
        <Button Content="Dashboard"
                Click="OnDashboardClick"
                Style="{StaticResource SecondaryButtonStyle}"
                Padding="16,8" />
        <Button Content="History"
                Click="OnHistoryClick"
                Style="{StaticResource SecondaryButtonStyle}"
                Padding="16,8" />
        <Button Content="Settings"
                Click="OnSettingsClick"
                Style="{StaticResource SecondaryButtonStyle}"
                Padding="16,8" />
      </StackPanel>

      <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="10" VerticalAlignment="Center">
        <Button Content="ðŸ”Š"
                Command="{Binding ToggleSoundCommand}"
                Style="{StaticResource SecondaryButtonStyle}"
                Padding="8" />
        <Button Content="âš™ï¸"
                Click="OnSettingsClick"
                Style="{StaticResource SecondaryButtonStyle}"
                Padding="8" />
      </StackPanel>
    </Grid>

    <!-- Main Content -->
    <ScrollViewer Grid.Row="1" Padding="20">
      <Grid RowSpacing="30">
        <Grid.RowDefinitions>
          <RowDefinition Height="Auto" />
          <RowDefinition Height="Auto" />
          <RowDefinition Height="Auto" />
          <RowDefinition Height="Auto" />
          <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Mode Selection -->
        <Grid Grid.Row="0" ColumnSpacing="15">
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="*" />
          </Grid.ColumnDefinitions>

          <!-- Pomodoro Mode -->
          <Border Grid.Column="0"
                  Style="{StaticResource CardStyle}"
                  Background="{Binding Mode, Converter={StaticResource ModeToColorConverter}, ConverterParameter=pomodoro}">
            <Button Command="{Binding ChangeModeCommand}"
                    CommandParameter="pomodoro"
                    Style="{StaticResource PrimaryButtonStyle}"
                    Content="Pomodoro"
                    Margin="0" />
          </Border>

          <!-- Short Break Mode -->
          <Border Grid.Column="1"
                  Style="{StaticResource CardStyle}"
                  Background="{Binding Mode, Converter={StaticResource ModeToColorConverter}, ConverterParameter=shortBreak}">
            <Button Command="{Binding ChangeModeCommand}"
                    CommandParameter="shortBreak"
                    Style="{StaticResource PrimaryButtonStyle}"
                    Content="Short Break"
                    Margin="0" />
          </Border>

          <!-- Long Break Mode -->
          <Border Grid.Column="2"
                  Style="{StaticResource CardStyle}"
                  Background="{Binding Mode, Converter={StaticResource ModeToColorConverter}, ConverterParameter=longBreak}">
            <Button Command="{Binding ChangeModeCommand}"
                    CommandParameter="longBreak"
                    Style="{StaticResource PrimaryButtonStyle}"
                    Content="Long Break"
                    Margin="0" />
          </Border>
        </Grid>

        <!-- Timer Display -->
        <Border Grid.Row="1" Style="{StaticResource CardStyle}">
          <StackPanel Spacing="20">
            <TextBlock x:Name="TimerDisplay"
                       Text="{Binding TimeLeft, Converter={StaticResource TimeToStringConverter}}"
                       Style="{StaticResource TimerDisplayStyle}" />

            <!-- Progress Ring -->
            <ProgressRing Value="{Binding ProgressPercentage}"
                          Maximum="100"
                          Width="120"
                          Height="120"
                          IsActive="{Binding IsRunning}"
                          Foreground="{Binding Mode, Converter={StaticResource ModeToColorConverter}}" />

            <!-- Session Info -->
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Spacing="15">
              <TextBlock Text="{Binding Mode, Converter={StaticResource ModeToTextConverter}}"
                         FontSize="16"
                         Foreground="{StaticResource OnSurfaceVariantColor}" />
              <TextBlock Text="â€¢"
                         FontSize="16"
                         Foreground="{StaticResource OnSurfaceVariantColor}" />
              <TextBlock Text="{Binding SessionInfo}"
                         FontSize="16"
                         Foreground="{StaticResource OnSurfaceVariantColor}" />
            </StackPanel>
          </StackPanel>
        </Border>

        <!-- Timer Controls -->
        <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Center" Spacing="15">
          <Button Content="{Binding IsRunning, Converter={StaticResource BoolToStringConverter}, ConverterParameter=â¸ Pause/â–¶ Start}"
                  Command="{Binding ToggleTimerCommand}"
                  Style="{StaticResource PrimaryButtonStyle}"
                  Width="120"
                  Height="48" />
          <Button Content="â†º Reset"
                  Command="{Binding ResetTimerCommand}"
                  Style="{StaticResource SecondaryButtonStyle}"
                  Width="120"
                  Height="48" />
          <Button Content="â­ Skip"
                  Command="{Binding SkipSessionCommand}"
                  Style="{StaticResource SecondaryButtonStyle}"
                  Width="120"
                  Height="48" />
        </StackPanel>

        <!-- Quick Actions -->
        <Grid Grid.Row="3" ColumnSpacing="15">
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="*" />
          </Grid.ColumnDefinitions>

          <!-- Sound Control -->
          <Border Grid.Column="0" Style="{StaticResource CardStyle}">
            <StackPanel Orientation="Horizontal" Spacing="10">
              <Button Content="{Binding IsSoundEnabled, Converter={StaticResource BoolToStringConverter}, ConverterParameter=ðŸ”‡/ðŸ”Š}"
                      Command="{Binding ToggleSoundCommand}"
                      Style="{StaticResource SecondaryButtonStyle}" />
              <Button Content="Test Sound"
                      Command="{Binding TestSoundCommand}"
                      Style="{StaticResource SecondaryButtonStyle}" />
              <Button Content="Stop Alarm"
                      Command="{Binding StopAlarmCommand}"
                      Style="{StaticResource PrimaryButtonStyle}"
                      Visibility="{Binding IsRinging, Converter={StaticResource BoolToVisibilityConverter}}" />
            </StackPanel>
          </Border>

          <!-- Session Control -->
          <Border Grid.Column="1" Style="{StaticResource CardStyle}">
            <StackPanel Orientation="Horizontal" Spacing="10">
              <Button Content="New Session"
                      Command="{Binding StartNewSessionCommand}"
                      Style="{StaticResource PrimaryButtonStyle}" />
              <Button Content="View Tasks"
                      Command="{Binding ToggleTasksCommand}"
                      Style="{StaticResource SecondaryButtonStyle}" />
            </StackPanel>
          </Border>
        </Grid>

        <!-- Current Tasks -->
        <Border Grid.Row="4" Style="{StaticResource CardStyle}" Visibility="{Binding ShowTasks, Converter={StaticResource BoolToVisibilityConverter}}">
          <StackPanel Spacing="15">
            <TextBlock Text="Current Session Tasks"
                       FontSize="20"
                       FontWeight="Medium"
                       Foreground="{StaticResource OnSurfaceColor}" />

            <!-- Add Task -->
            <Grid ColumnSpacing="10">
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
              </Grid.ColumnDefinitions>

              <TextBox Grid.Column="0"
                       Text="{Binding NewTask, Mode=TwoWay}"
                       PlaceholderText="Add a new task..."
                       Style="{StaticResource PrimaryButtonStyle}" />

              <Button Grid.Column="1"
                      Content="Add"
                      Command="{Binding AddTaskCommand}"
                      Style="{StaticResource PrimaryButtonStyle}" />
            </Grid>

            <!-- Task List -->
            <ItemsControl x:Name="TaskList" ItemsSource="{Binding Tasks}">
              <ItemsControl.ItemTemplate>
                <DataTemplate>
                  <Border Margin="0,5,0,5"
                          Padding="10"
                          CornerRadius="8"
                          Background="{StaticResource SurfaceVariantColor}">
                    <Grid ColumnSpacing="10">
                      <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                      </Grid.ColumnDefinitions>

                      <CheckBox Grid.Column="0"
                                IsChecked="{Binding Completed, Mode=TwoWay}" />

                      <TextBlock Grid.Column="1"
                                 Text="{Binding Text}"
                                 VerticalAlignment="Center"
                                 Foreground="{Binding Completed, Converter={StaticResource BoolToColorConverter}}"
                                 Opacity="{Binding Completed, Converter={StaticResource BoolToOpacityConverter}}" />

                      <Button Grid.Column="2"
                              Content="Ã—"
                              Command="{Binding DataContext.DeleteTaskCommand, ElementName=TaskList}"
                              CommandParameter="{Binding Id}"
                              Style="{StaticResource SecondaryButtonStyle}" />
                    </Grid>
                  </Border>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
            </ItemsControl>
          </StackPanel>
        </Border>
      </Grid>
    </ScrollViewer>
  </Grid>
</Page>
