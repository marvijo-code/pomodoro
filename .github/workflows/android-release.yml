name: Android Release Build

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type when running on main (patch|minor|major|none)'
        required: false
        default: 'patch'

concurrency:
  group: android-release
  cancel-in-progress: false

jobs:
  test:
    runs-on: windows-latest
    if: ${{ !(startsWith(github.ref, 'refs/tags/v') && github.actor == 'github-actions[bot]') }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Restore test dependencies
      run: dotnet restore UnoPomodoro.Tests/UnoPomodoro.Tests.csproj
      working-directory: UnoPomodoro

    - name: Run tests with coverage
      run: >
        dotnet test UnoPomodoro.Tests/UnoPomodoro.Tests.csproj
        --configuration Release
        --no-restore
        --logger "trx;LogFileName=test-results.trx"
        --collect:"XPlat Code Coverage"
        -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=cobertura
      working-directory: UnoPomodoro

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: UnoPomodoro/UnoPomodoro.Tests/TestResults/
        retention-days: 14

  build:
    runs-on: windows-latest
    needs: test
    permissions:
      contents: write
    if: ${{ !(startsWith(github.ref, 'refs/tags/v') && github.actor == 'github-actions[bot]') }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Install .NET workloads
      run: dotnet workload restore UnoPomodoro/UnoPomodoro/UnoPomodoro.csproj

    - name: Determine version
      id: version
      shell: pwsh
      run: |
        git fetch --tags --force
        if ($LASTEXITCODE -ne 0) {
          throw "git fetch --tags --force failed with exit code $LASTEXITCODE"
        }

        $bump = "${{ github.event.inputs.bump }}"
        if (-not $bump) { $bump = "patch" }
        $bump = $bump.ToLowerInvariant()

        $ref = "${{ github.ref }}"
        $refName = "${{ github.ref_name }}"

        function Get-VersionCode([int]$major, [int]$minor, [int]$patch) {
          return ($major * 10000) + ($minor * 100) + $patch
        }

        if ($ref.StartsWith("refs/tags/")) {
          if ($refName -notmatch '^v\d+\.\d+\.\d+$') {
            throw "Tag '$refName' must match v<major>.<minor>.<patch> (e.g., v1.0.3)"
          }

          $version = $refName.Substring(1)
          $parts = $version.Split('.')
          $major = [int]$parts[0]
          $minor = [int]$parts[1]
          $patch = [int]$parts[2]
          $versionCode = Get-VersionCode $major $minor $patch

          "VERSION=$version" >> $env:GITHUB_OUTPUT
          "TAG=$refName" >> $env:GITHUB_OUTPUT
          "VERSION_CODE=$versionCode" >> $env:GITHUB_OUTPUT
          "BUMP=tag" >> $env:GITHUB_OUTPUT
          "IS_TAG=true" >> $env:GITHUB_OUTPUT
          exit 0
        }

        "IS_TAG=false" >> $env:GITHUB_OUTPUT

        $tags = git tag --list 'v*' --sort=-v:refname | Where-Object { $_ -match '^v\d+\.\d+\.\d+$' }
        $latestTag = $tags | Select-Object -First 1
        if (-not $latestTag) { $latestTag = 'v1.0.0' }

        $latestVersion = $latestTag.Substring(1)
        $p = $latestVersion.Split('.')
        $major = [int]$p[0]
        $minor = [int]$p[1]
        $patch = [int]$p[2]

        switch ($bump) {
          'none' { }
          'major' { $major += 1; $minor = 0; $patch = 0 }
          'minor' { $minor += 1; $patch = 0 }
          default { $patch += 1 }
        }

        if ($bump -ne 'none') {
          while ($true) {
            $candidateTag = "v$major.$minor.$patch"
            git rev-parse -q --verify "refs/tags/$candidateTag" 1>$null 2>$null
            if ($LASTEXITCODE -ne 0) {
              # git rev-parse returns non-zero when the tag does not exist; reset so the step doesn't fail.
              $global:LASTEXITCODE = 0
              break
            }
            $patch += 1
          }
        }

        if ($bump -eq 'none') {
          $versionCode = Get-VersionCode $major $minor $patch
          "VERSION=$latestVersion" >> $env:GITHUB_OUTPUT
          "TAG=" >> $env:GITHUB_OUTPUT
          "VERSION_CODE=$versionCode" >> $env:GITHUB_OUTPUT
          "BUMP=none" >> $env:GITHUB_OUTPUT
          exit 0
        }

        $newVersion = "$major.$minor.$patch"
        $newTag = "v$newVersion"
        $versionCode = Get-VersionCode $major $minor $patch

        "VERSION=$newVersion" >> $env:GITHUB_OUTPUT
        "TAG=$newTag" >> $env:GITHUB_OUTPUT
        "VERSION_CODE=$versionCode" >> $env:GITHUB_OUTPUT
        "BUMP=$bump" >> $env:GITHUB_OUTPUT

        exit 0

    - name: Build Release APK (versioned)
      run: >
        dotnet build UnoPomodoro/UnoPomodoro/UnoPomodoro.csproj -c Release -f net10.0-android
        -p:ApplicationDisplayVersion=${{ steps.version.outputs.VERSION }}
        -p:ApplicationVersion=${{ steps.version.outputs.VERSION_CODE }}

    - name: Find APK
      id: find_apk
      shell: pwsh
      run: |
        $apk = Get-ChildItem -Path "UnoPomodoro/UnoPomodoro/bin/Release/net10.0-android" -Filter "*.apk" -Recurse | Select-Object -First 1
        if (-not $apk) {
          throw "No APK found under UnoPomodoro/UnoPomodoro/bin/Release/net10.0-android"
        }

        $version = "${{ steps.version.outputs.VERSION }}"
        $outDir = Join-Path $env:GITHUB_WORKSPACE "artifacts"
        New-Item -ItemType Directory -Force -Path $outDir | Out-Null

        $outName = "PomodoroVijo-android-v$version.apk"
        $outPath = Join-Path $outDir $outName
        Copy-Item -Force $apk.FullName $outPath

        "APK_PATH=$outPath" >> $env:GITHUB_OUTPUT
        "APK_NAME=$outName" >> $env:GITHUB_OUTPUT
        $size = [math]::Round((Get-Item $outPath).Length / 1MB, 2)
        "APK_SIZE=$size MB" >> $env:GITHUB_OUTPUT

    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: uno-pomodoro-apk
        path: ${{ steps.find_apk.outputs.APK_PATH }}
        retention-days: 30

    - name: Create and push tag
      if: ${{ steps.version.outputs.IS_TAG != 'true' && steps.version.outputs.BUMP != 'none' && steps.version.outputs.TAG != '' }}
      shell: pwsh
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        $tag = "${{ steps.version.outputs.TAG }}"
        git tag $tag
        git push origin $tag

    - name: Create Release
      if: ${{ steps.version.outputs.TAG != '' }}
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.version.outputs.TAG }}
        name: ${{ steps.version.outputs.TAG }}
        files: ${{ steps.find_apk.outputs.APK_PATH }}
        body: |
          ## UnoPomodoro Android Release

          **Version:** ${{ steps.version.outputs.VERSION }}
          **APK Size:** ${{ steps.find_apk.outputs.APK_SIZE }}

          ### Features
          - Professional Material Design 3 dark theme
          - Pomodoro timer with customizable work/break intervals
          - Configurable focus, short break, and long break durations
          - Auto-start breaks and pomodoros
          - Long break after N pomodoros
          - Vibration notifications
          - Task management with SQLite persistence
          - Task editing and session notes
          - Notification sounds with volume/duration control
          - Analog clock visualization
          - Session history, statistics, and achievements
          - Keep screen awake mode
          - Settings persistence across app restarts

          ### Installation
          Download the APK and install on your Android device (Android 5.0+)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
